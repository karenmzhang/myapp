var express = require('express');
var router = express.Router();

var requestTime = (req, res, next) => {
   req.requestTime = Date.now();
   next();

   const { spawn } = require('child_process');
   const fs = require('fs');

   fs.writeFile('HelloWorld.java', req.body.code, (err) => {
         if (err) throw err;
         
         console.log('file saved');
      });

   // const child = spawn('javac HelloWorld.java');
   const child = spawn('pwd');

   child.on('exit', function (code, signal) {
      console.log('child process exited with ' +
                  `code ${code} and signal ${signal}`);
   });

   child.stdout.on('data', (data) => {
      console.log(`child stdout:\n${data}`);
   });

   child.stderr.on('data', (data) => {
      console.error(`child stderr:\n${data}`);
   });
};
 
/* Log the current time and the body of the request */
router.use(requestTime);

/*
const { spawn } = require('child_process');
const child = spawn('pwd');

child.on('exit', function (code, signal) {
      console.log('child process exited with ' +
                  `code ${code} and signal ${signal}`);
   });

child.stdout.on('data', (data) => {
      console.log(`child stdout:\n${data}`);
   });

child.stderr.on('data', (data) => {
      console.error(`child stderr:\n${data}`);
   }); 
*/

router.post('/', (req, res) => {
      var responseText = req.body.code + '\n';
      responseText += 'Submitted at: ' + req.requestTime + '\n';
      res.send(responseText);
   })

module.exports = router;